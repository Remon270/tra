<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tracking Link Generator & Viewer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b);
    min-height: 100vh;
    margin: 0;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }

  h1 {
    margin-bottom: 0.25rem;
    font-weight: 600;
    font-size: 2.5rem;
    letter-spacing: 0.05em;
  }

  p.subtitle {
    margin: 0 0 2rem;
    font-weight: 400;
    font-style: italic;
    color: #ffd6d6cc;
  }

  .container {
    background: rgba(255 255 255 / 0.1);
    border-radius: 12px;
    padding: 2rem;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  }

  label {
    font-weight: 600;
    display: block;
    margin-bottom: 0.5rem;
  }

  input[type="text"] {
    width: 100%;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    margin-bottom: 1rem;
    outline: none;
  }

  button {
    background: #ffaf7b;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    color: #3a1c71;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s ease;
    width: 100%;
  }

  button:hover {
    background: #d76d77;
    color: #fff;
  }

  .links-list, .visits-list {
    margin-top: 2rem;
    max-height: 300px;
    overflow-y: auto;    
    background: rgba(255 255 255 / 0.15);
    border-radius: 10px;
    padding: 1rem;
  }

  .links-list h2, .visits-list h2 {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
    text-align: center;
  }

  .link-item {
    word-break: break-all;
    background: rgba(255 255 255 / 0.2);
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
  }

  .link-text {
    flex: 1 1 auto;
  }

  .btn-copy {
    background: #3a1c71;
    color: #ffaf7b;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    padding: 0.3rem 0.6rem;
    font-size: 0.85rem;
    margin-left: 8px;
    transition: background 0.3s ease;
  }
  .btn-copy:hover {
    background: #d76d77;
    color: #fff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    color: white;
  }

  th, td {
    border-bottom: 1px solid rgba(255 255 255 / 0.3);
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
  }

  th {
    font-weight: 600;
    background: rgba(255 255 255 / 0.15);
  }

  .message {
    margin-top: 1rem;
    text-align: center;
    font-weight: 600;
    font-size: 1rem;
  }

  @media (max-width: 520px) {
    .container {
      max-width: 95vw;
    }
  }
</style>
</head>
<body>
  <h1>Tracking Link Generator</h1>
  <p class="subtitle">Create tracking links and see visitors' locations</p>
  <div class="container" id="main-container">
    <label for="track-name-input">Tracking Link Name (optional)</label>
    <input type="text" id="track-name-input" placeholder="Enter a name for your tracking link" />

    <button id="generate-btn">Generate Tracking Link</button>

    <div class="links-list" id="links-container" style="display:none;">
      <h2>Your Tracking Links</h2>
      <div id="links-list"></div>
    </div>

    <div class="visits-list" id="visits-container" style="display:none;">
      <h2>Tracking Visits</h2>
      <table id="visits-table" aria-label="List of tracking visits">
        <thead>
          <tr>
            <th>Tracking Link ID</th>
            <th>Tracking Name</th>
            <th>Timestamp</th>
            <th>Latitude</th>
            <th>Longitude</th>
          </tr>
        </thead>
        <tbody id="visits-tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="container" id="tracking-page-container" style="display:none; text-align:center;">
    <h2>Tracking Link Opened</h2>
    <p id="tracking-status">Getting your location...</p>
  </div>

<script>
(function() {
  // Helper for generating unique IDs
  function makeId(length = 8) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for(let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Local storage keys
  const LINKS_KEY = 'tracking_links';
  const VISITS_KEY = 'tracking_visits';

  // Load tracking links from localStorage
  function loadLinks() {
    try {
      const data = localStorage.getItem(LINKS_KEY);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      return [];
    }
  }

  // Save tracking links to localStorage
  function saveLinks(links) {
    localStorage.setItem(LINKS_KEY, JSON.stringify(links));
  }

  // Load visits from localStorage
  function loadVisits() {
    try {
      const data = localStorage.getItem(VISITS_KEY);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      return [];
    }
  }

  // Save visits to localStorage
  function saveVisits(visits) {
    localStorage.setItem(VISITS_KEY, JSON.stringify(visits));
  }

  // Add a visit record
  function addVisit(visit) {
    const visits = loadVisits();
    visits.push(visit);
    saveVisits(visits);
  }

  // Format date string from timestamp
  function formatTimestamp(ts) {
    const d = new Date(ts);
    return d.toLocaleString();
  }

  // Copy text to clipboard
  function copyText(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
      }, () => {
        alert('Failed to copy. Please copy manually.');
      });
    } else {
      alert('Clipboard API not supported. Please copy manually.');
    }
  }

  // Generate a tracking link and save it
  function generateTrackingLink(name) {
    const links = loadLinks();
    const id = makeId(10);
    const baseUrl = window.location.origin + window.location.pathname;
    const fullUrl = baseUrl + '?track=' + id;
    const newLink = { id, name: name || '', url: fullUrl };
    links.push(newLink);
    saveLinks(links);
    return newLink;
  }

  // Render tracking links list
  function renderLinks() {
    const container = document.getElementById('links-list');
    const links = loadLinks();
    if (links.length === 0) {
      container.innerHTML = '<p>You have not generated any tracking links yet.</p>';
      document.getElementById('links-container').style.display = 'none';
      return;
    }

    container.innerHTML = '';
    for (const link of links) {
      const div = document.createElement('div');
      div.className = 'link-item';

      const span = document.createElement('span');
      span.className = 'link-text';
      span.textContent = link.url + (link.name ? ' (' + link.name + ')' : '');

      const btnCopy = document.createElement('button');
      btnCopy.className = 'btn-copy';
      btnCopy.textContent = 'Copy';
      btnCopy.title = 'Copy link to clipboard';
      btnCopy.addEventListener('click', () => copyText(link.url));

      div.appendChild(span);
      div.appendChild(btnCopy);
      container.appendChild(div);
    }
    document.getElementById('links-container').style.display = 'block';
  }

  // Render visits list table
  function renderVisits() {
    const tbody = document.getElementById('visits-tbody');
    const visits = loadVisits();
    if (visits.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#ffd6d6cc;">No visits recorded yet.</td></tr>';
      document.getElementById('visits-container').style.display = 'none';
      return;
    }
    visits.sort((a,b) => b.timestamp - a.timestamp); // show newest first

    tbody.innerHTML = '';
    const links = loadLinks();
    function getNameById(id) {
      const found = links.find(l => l.id === id);
      return found ? found.name : '';
    }
    for (const visit of visits) {
      const tr = document.createElement('tr');

      const idTd = document.createElement('td');
      idTd.textContent = visit.trackingId || '';
      tr.appendChild(idTd);

      const nameTd = document.createElement('td');
      nameTd.textContent = getNameById(visit.trackingId);
      tr.appendChild(nameTd);

      const tsTd = document.createElement('td');
      tsTd.textContent = formatTimestamp(visit.timestamp);
      tr.appendChild(tsTd);

      const latTd = document.createElement('td');
      latTd.textContent = visit.latitude;
      tr.appendChild(latTd);

      const lonTd = document.createElement('td');
      lonTd.textContent = visit.longitude;
      tr.appendChild(lonTd);

      tbody.appendChild(tr);
    }
    document.getElementById('visits-container').style.display = 'block';
  }

  // On main page, handle generate button
  function mainPageSetup() {
    document.getElementById('generate-btn').addEventListener('click', () => {
      const nameInput = document.getElementById('track-name-input');
      const name = nameInput.value.trim();
      const newLink = generateTrackingLink(name);
      nameInput.value = '';
      renderLinks();
      renderVisits();
      alert('Tracking link generated and saved:\n' + newLink.url);
    });

    renderLinks();
    renderVisits();
  }

  // On tracking link page, get location and record visit
  function trackingPageSetup(trackId) {
    const container = document.getElementById('tracking-page-container');
    const status = document.getElementById('tracking-status');
    container.style.display = 'block';

    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser.';
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const { latitude, longitude } = position.coords;
      status.textContent = `Location recorded: Latitude ${latitude.toFixed(5)}, Longitude ${longitude.toFixed(5)}. Thank you!`;

      // Save visit record
      addVisit({
        trackingId: trackId,
        timestamp: Date.now(),
        latitude: latitude.toFixed(6),
        longitude: longitude.toFixed(6),
      });
    }, error => {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          status.textContent = 'Permission denied. Location not recorded.';
          break;
        case error.POSITION_UNAVAILABLE:
          status.textContent = 'Location information is unavailable.';
          break;
        case error.TIMEOUT:
          status.textContent = 'The request to get your location timed out.';
          break;
        default:
          status.textContent = 'An unknown error occurred.';
          break;
      }
    }, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    });
  }

  function init() {
    const params = new URLSearchParams(window.location.search);
    const trackId = params.get('track');

    if (trackId) {
      // We are on a tracking link page
      document.getElementById('main-container').style.display = 'none';
      trackingPageSetup(trackId);
    } else {
      // Normal main page with generator and data
      document.getElementById('tracking-page-container').style.display = 'none';
      mainPageSetup();
    }
  }

  init();
})();
</script>
</body>
</html>

